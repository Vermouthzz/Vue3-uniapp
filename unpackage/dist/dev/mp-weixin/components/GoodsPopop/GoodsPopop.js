"use strict";const t=require("../../common/vendor.js"),w=require("../../utils/mitt.js"),x=require("../../hooks/Set.js"),N=require("../../store/useCartStore.js");require("../../api/cart.js");require("../../request/index.js");require("../../store/useUserStore.js");require("../../store/useUserCardStore.js");require("../../api/user.js");if(!Array){const v=t.resolveComponent("van-stepper"),m=t.resolveComponent("van-popup");(v+m)()}const O={__name:"GoodsPopop",emits:["update:show"],setup(v,{emit:m}){const n=v,h=N.useCartStore(),p=t.ref(!0),f=t.ref(1);let d={};const _=t.ref("");t.watchEffect(()=>{n.goods&&(d=$(n.goods.sku),G(n.goods.sku_list,d),p.value&&y(),_.value=k(n.goods.sku_list).join(""))});const y=()=>{let e=h.cartList.find(o=>o.item_id==n.goods.item_id);if(e){f.value=e.count;for(let o in n.goods.sku_list)n.goods.sku_list[o].value.forEach(s=>{s.name==e.spec[o].value&&(s.selected=!0)});E()}};w.mitter.on("popup",e=>{p.value=e.isCart});const b=async e=>{if(Object.values(l).length===0){t.index.showToast({icon:"error",title:"请选择规格"});return}switch(e){case"add":let o={count:f.value,checked:!0,sku_id:l.id,goods_id:l.goods_id};h.addCart(o);break;case"confirm":let s={count:f.value,selected:!0,sku_id:l.id,item_id:n.goods.item_id};h.updateCart(s);break}C()},C=()=>{w.mitter.emit("selectName",_.value),m("update:show",!1)},A=e=>{f.value=e.detail},S="★",$=e=>(e==null||e.forEach(o=>{if(o.stock>0){let s=o.spec.map(c=>c.value),r=x.Set(s);r==null||r.forEach(c=>{const a=c.join(S);d[a]||(d[a]=[]),d[a].push(o.id)})}}),d);let l={};const D=(e,o)=>{e.disabled||(e.selected?e.selected=!1:(o==null||o.forEach(s=>s.selected=!1),e.selected=!0),P(n.goods.sku_list,d),E())},E=()=>{var o;const e=k(n.goods.sku_list).filter(s=>s);if(e.length===((o=n.goods.sku_list)==null?void 0:o.length)){const s=d[e.join(S)][0];l=n.goods.sku.find(r=>r.id===s)}else l={}};t.computed(()=>Object.values(l).length?l:{pic:n.goods.goods_img,price:n.goods.goods_price});const k=e=>{let o=[];return e==null||e.forEach((s,r)=>{const c=s.value.find(a=>a.selected);c?o[r]=c.name:o[r]=void 0}),o},G=(e,o)=>{e&&o.length>0&&(e==null||e.forEach(s=>{s.disabled=!o[s.name]}))},P=(e,o)=>{e==null||e.forEach((s,r)=>{var a;const c=k(e);(a=s.value)==null||a.forEach(u=>{if(!u.selected){c[r]=u.name;const i=c.filter(q=>q).join(S);u.disabled=!o[i]}})})};return(e,o)=>{var s,r,c,a,u;return t.e({a:((s=t.unref(l))==null?void 0:s.pic)||((r=n.goods)==null?void 0:r.goods_img),b:t.t((c=n.goods)==null?void 0:c.service),c:t.t(((a=t.unref(l))==null?void 0:a.price)||n.goods.goods_price),d:t.t(_.value?_.value:"请选择规格"),e:t.f((u=n.goods)==null?void 0:u.sku_list,(i,q,T)=>({a:t.t(i.name),b:t.f(i.value,(g,j,z)=>({a:t.t(g.name),b:j,c:t.o(B=>D(g,i.value),j),d:g.selected?1:"",e:g.disabled?1:""})),c:i.name})),f:t.o(A),g:t.p({value:f.value}),h:p.value},p.value?{i:t.o(i=>b("confirm"))}:{j:t.o(i=>b("add")),k:t.o(i=>b("buy"))},{l:t.o(C),m:t.p({show:n.show,position:"bottom",closeable:!0})})}}},V=t._export_sfc(O,[["__file","D:/github/app-unis/components/GoodsPopop/GoodsPopop.vue"]]);wx.createComponent(V);
