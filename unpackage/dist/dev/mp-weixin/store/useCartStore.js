"use strict";const r=require("../common/vendor.js"),i=require("../api/cart.js"),I=require("./useUserStore.js"),k=require("./useUserCardStore.js"),S=r.defineStore("cart",()=>{const c=I.useUserStore(),v=k.useUserCardStore(),s=r.ref([]),a=r.computed(()=>s.value.flat().reduce((e,t)=>[...e,...t.value],[])),n=r.computed(()=>a.value.filter(e=>e.selected).reduce((e,t)=>(e[t.goods_id]||(e[t.goods_id]=[]),e[t.goods_id].push(t),e),[]).filter(e=>!0)),f=r.computed(()=>s.value.every(e=>e[0].value.every(t=>t.selected))),p=e=>{s.value.forEach(t=>t[0].value.forEach(d=>d.selected=e)),m(a.value)},u=r.computed(()=>a.value.filter(e=>e.selected).reduce((e,t)=>e+t.sku_item.retail_price*t.count,0)),l=r.computed(()=>a.value.filter(e=>e.selected).reduce((e,t)=>e+t.sku_item.price*t.count,0)),C=r.computed(()=>l.value-u.value),_=r.computed(()=>{let e=v.optimalTicket(u.value),t;return e&&(t=(e.ticket_price/n.value.length).toFixed(2)),t||0}),g=async e=>{let t=s.value.find(d=>d.item_id==e.item_id);t?(e.count+=t.count,await i.updateCartAPI([{id:t.item_id,count:e.count,sku_id:t.sku_id,selected:t.selected}])):await i.addCartAPI(e),o(c.userInfo.id)},o=async()=>{const e=await i.getCartListAPI(c.userInfo.id);s.value=e},h=async e=>{r.index.showLoading({mask:!0}),await i.delCartAPI(e)&&r.index.hideLoading(),o(c.userInfo.id)},m=async e=>{r.index.showLoading({mask:!0}),await i.updateCartAPI(e)&&r.index.hideLoading(),o()};return{cartList:s,allChecked:f,allPrice:l,addCart:g,getCartList:o,updateCart:m,onAllChange:p,delCartItem:h,selectedItems:n,itemValues:a,allRetailPrice:u,reNum:_,activeFee:C}});exports.useCartStore=S;
